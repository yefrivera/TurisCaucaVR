<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panolens.js VR with Controllers</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r121/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/panolens@0.12.0/build/panolens.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/motion-controllers@1.0.0-beta.3/dist/motion-controllers.module.js"></script>
    <style>
        body { margin: 0; }
        #panorama { width: 100%; height: 100vh; }
        .vr-button { position: absolute; top: 10px; right: 10px; z-index: 1; }
    </style>
</head>
<body>
    <div id="panorama"></div>
    <button class="vr-button">Enter VR</button>
    <script>
        // Crear los panoramas
        const panorama1 = new PANOLENS.ImagePanorama('./images/centrocaldas.jpg');
        const panorama2 = new PANOLENS.ImagePanorama('./images/catedral.jpg');

        // Crear el visor con soporte WebXR
        const viewer = new PANOLENS.Viewer({ container: document.querySelector('#panorama'), output: 'console' });

        // Añadir los panoramas al visor
        viewer.add(panorama1, panorama2);

        // Crear y añadir infospots
        const infospot1 = new PANOLENS.Infospot(300, PANOLENS.DataImage.Info);
        infospot1.position.set(5000, 0, 0);
        infospot1.addHoverText('Ir a escena 2');
        infospot1.addEventListener('click', function() {
            viewer.setPanorama(panorama2);
        });
        panorama1.add(infospot1);

        const infospot2 = new PANOLENS.Infospot(300, PANOLENS.DataImage.Info);
        infospot2.position.set(-5000, 0, 0);
        infospot2.addHoverText('Regresar a escena 1');
        infospot2.addEventListener('click', function() {
            viewer.setPanorama(panorama1);
        });
        panorama2.add(infospot2);

        // Configuración de cámara personalizada
        viewer.OrbitControls.noZoom = false;
        viewer.OrbitControls.noPan = false;

        // Inicializar con el primer panorama
        viewer.setPanorama(panorama1);

        // Configurar el botón para entrar en VR
        const vrButton = document.querySelector('.vr-button');
        vrButton.addEventListener('click', function() {
            if (viewer.camera) {
                const renderer = viewer.getRenderer();
                renderer.xr.enabled = true;
                renderer.xr.setReferenceSpaceType('local');
                document.body.appendChild(THREE.VRButton.createButton(renderer));

                // Añadir controladores VR
                const controller1 = renderer.xr.getController(0);
                controller1.addEventListener('selectstart', onSelectStart);
                controller1.addEventListener('selectend', onSelectEnd);
                viewer.scene.add(controller1);

                const controller2 = renderer.xr.getController(1);
                controller2.addEventListener('selectstart', onSelectStart);
                controller2.addEventListener('selectend', onSelectEnd);
                viewer.scene.add(controller2);
            }
        });

        function onSelectStart(event) {
            const controller = event.target;
            const intersections = getIntersections(controller);

            if (intersections.length > 0) {
                const intersection = intersections[0];
                const object = intersection.object;
                controller.userData.selected = object;
            }
        }

        function onSelectEnd(event) {
            const controller = event.target;

            if (controller.userData.selected !== undefined) {
                const object = controller.userData.selected;
                object.material.emissive.b = 0;
                controller.userData.selected = undefined;
            }
        }

        function getIntersections(controller) {
            const tempMatrix = new THREE.Matrix4();
            tempMatrix.identity().extractRotation(controller.matrixWorld);

            const raycaster = new THREE.Raycaster();
            raycaster.ray.origin.setFromMatrixPosition(controller.matrixWorld);
            raycaster.ray.direction.set(0, 0, -1).applyMatrix4(tempMatrix);

            return raycaster.intersectObjects(viewer.scene.children, false);
        }
    </script>
</body>
</html>
